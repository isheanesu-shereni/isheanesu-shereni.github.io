<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <style>
            html, body {
                background-color: #ffffff;
            }
            .ol-control > * {
                background-color: #f8f8f8!important;
                color: #444444!important;
                border-radius: 0px;
            }
            .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
                color: #444444!important;
            }
            .search-layer-input-search {
                background-color: #f8f8f8!important;
            }
            .ol-control > *:focus, .ol-control >*:hover {
                background-color: rgba(248, 248, 248, 0.7)!important;
            } 
            .ol-control {
                background-color: rgba(255,255,255,.4) !important;
                padding: 2px !important;
            } 
            html, body, #map {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }
            #leaflet-map {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1; /* Ensure Leaflet is on top of OpenLayers */
            }
            #button {
                position: absolute;
                top: 10px;
                left: 10px;
                padding: 10px;
                background: #007bff;
                color: white;
                z-index: 2; /* Button is on top */
            }
        </style>
        <title>Map Integration with Earth Engine Rainfall</title>
    </head>
    <body>
        <!-- Button to trigger data fetch -->
        <button id="button">Get Rainfall Data</button>

        <!-- OpenLayers map container (already present) -->
        <div id="map"></div>

        <!-- Leaflet map container -->
        <div id="leaflet-map"></div>

        <script src="resources/qgis2web_expressions.js"></script>
        <script src="resources/proj4.js"></script>
        <script>proj4.defs('EPSG:3857','+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs');</script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="layers/Domboshawaboundary_0.js"></script>
        <script src="layers/countourlines_1.js"></script>
        <script src="layers/Buildings_2.js"></script>
        <script src="layers/Clinic_3.js"></script>
        <script src="layers/Landmarkplaces_4.js"></script>
        <script src="layers/Road_5.js"></script>
        <script src="layers/School_6.js"></script>
        <script src="layers/Waterway_7.js"></script>
        <script src="layers/Waterbody_8.js"></script>
        <script src="styles/Domboshawaboundary_0_style.js"></script>
        <script src="styles/countourlines_1_style.js"></script>
        <script src="styles/Buildings_2_style.js"></script>
        <script src="styles/Clinic_3_style.js"></script>
        <script src="styles/Landmarkplaces_4_style.js"></script>
        <script src="styles/Road_5_style.js"></script>
        <script src="styles/School_6_style.js"></script>
        <script src="styles/Waterway_7_style.js"></script>
        <script src="styles/Waterbody_8_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <!-- Earth Engine API -->
        <script src="https://unpkg.com/earthengine-api"></script>

        <script>
            // Initialize the OpenLayers map (existing map)
            var olMap = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([37.7749, -122.4194]), // San Francisco example center
                    zoom: 10
                })
            });

            // Initialize the Leaflet map to overlay it on top of the OpenLayers map
            var leafletMap = L.map('leaflet-map').setView([37.7749, -122.4194], 10); // Same center as OpenLayers

            // Add OpenStreetMap tile layer to Leaflet
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);

            // Function to handle the button click and trigger Earth Engine task
            document.getElementById('button').onclick = function() {
                // Trigger the GEE data extraction
                getRainfallData();
            };

            function getRainfallData() {
                // Authenticate and initialize Earth Engine
                ee.Initialize();

                // Define Area of Interest (AOI) (same as Leaflet and OpenLayers center)
                var aoi = ee.Geometry.Polygon([
                    [[-122.5, 37.7], [-122.5, 37.8], [-122.4, 37.8], [-122.4, 37.7]]
                ]);

                // Fetch the rainfall data (e.g., CHIRPS data)
                var dataset = ee.ImageCollection("UCSB-CHG/CHIRPS/DAILY")
                    .filterBounds(aoi)
                    .sort('system:time_start', false)
                    .limit(1);

                var rainfallImage = dataset.first();

                // Optionally, classify or manipulate the image here if needed
                var rainfallVis = {
                    min: 0.0,
                    max: 300.0,
                    palette: ['blue', 'green', 'yellow', 'red']
                };

                // Add the rainfall data to the map
                var rainfallLayer = ee.Image(rainfallImage).visualize(rainfallVis);

                // Convert the Earth Engine image to a Leaflet-friendly format
                var rainfallLayerUrl = rainfallLayer.getMap().urlFormat;
                var rainfallOverlay = L.imageOverlay(rainfallLayerUrl, [
                    [37.7, -122.5], [37.8, -122.5], [37.8, -122.4], [37.7, -122.4]
                ]).addTo(leafletMap);
            }
        </script>
    </body>
</html>
