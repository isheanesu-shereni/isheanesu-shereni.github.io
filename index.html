<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        html, body {
            background-color: #ffffff;
        }
        html, body, #map, #leaflet-map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            position: absolute;
        }
        #leaflet-map {
            z-index: 1; /* Leaflet map on top */
        }
        #map {
            z-index: -1; /* OpenLayers map below Leaflet map */
        }
        #button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 10px;
            background: #007bff;
            color: white;
            z-index: 2; /* Button on top of both maps */
        }
    </style>

    <title>Map Integration with Earth Engine Rainfall</title>
</head>
<body>
    <!-- Button to trigger data fetch -->
    <button id="button">Get Rainfall Data</button>

    <!-- Leaflet map container -->
    <div id="leaflet-map"></div>

    <!-- OpenLayers map container (existing map) -->
    <div id="map"></div>

    <!-- Include Leaflet and Earth Engine API -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/earthengine-api"></script>

    <script>
        // Initialize the OpenLayers map (existing map)
        var olMap = new ol.Map({
            target: 'map', // OpenLayers map in #map div
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                }),
                // Add your other vector layers here
                new ol.layer.Vector({
                    source: new ol.source.Vector({
                        url: 'path-to-your-geojson-file', // Replace with actual source
                        format: new ol.format.GeoJSON()
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([31.1500, -17.6000]), // Center on your AOI
                zoom: 9
            })
        });

        // Initialize the Leaflet map, but only when the button is clicked
        var leafletMap;

        // Function to handle the button click and trigger Earth Engine task
        document.getElementById('button').onclick = function() {
            // Initialize Leaflet map on button click if not already initialized
            if (!leafletMap) {
                leafletMap = L.map('leaflet-map').setView([-17.6, 31.15], 9); // Set Leaflet map to same view as OpenLayers
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
            }

            // Trigger the GEE data extraction
            getRainfallData();
        };

        function getRainfallData() {
            // Initialize Earth Engine
            ee.Initialize();

            // Define Area of Interest (AOI)
            var aoi = ee.Geometry.Polygon([
                [[31.000000, -17.700000], [31.000000, -17.500000], [31.300000, -17.500000], [31.300000, -17.700000]]
            ]);

            // Load CHIRPS dataset & Get the Most Recent Image
            var dataset = ee.ImageCollection("UCSB-CHG/CHIRPS/DAILY")
                .filterBounds(aoi)
                .sort('system:time_start', false)  
                .limit(1);  

            var recentRainfall = dataset.first();

            // Interpolate using Focal Mean (Smooth the Raster)
            var interpolated = recentRainfall.focalMean(10000, 'circle', 'meters');

            // Classify into 5 Rainfall Categories
            var classified = interpolated.multiply(100).int()
                .where(interpolated.lt(25), 1)  
                .where(interpolated.gte(25).and(interpolated.lt(50)), 2)  
                .where(interpolated.gte(50).and(interpolated.lt(75)), 3)  
                .where(interpolated.gte(75).and(interpolated.lt(100)), 4) 
                .where(interpolated.gte(100), 5)  
                .selfMask(); // Keeps transparency (removes NoData)

            // Define the correct color palette for the classified data
            var rainfallPalette = ['#ff0000', '#ff9900', '#ffff00', '#00ccff', '#0000ff'];

            // Convert Earth Engine Image to a URL for Leaflet
            var rainfallLayerUrl = classified.getMap({
                min: 1,
                max: 5,
                palette: rainfallPalette,
                opacity: 0.5
            }).urlFormat;

            // Add the rainfall data to the Leaflet map as an image overlay
            var bounds = [[-17.7, 31.0], [-17.5, 31.3]]; // Define the bounds of the AOI
            var rainfallOverlay = L.imageOverlay(rainfallLayerUrl, bounds).addTo(leafletMap);
        }
    </script>
</body>
</html>
